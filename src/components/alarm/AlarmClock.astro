---
/**
 * Alarm Clock Component
 * Componente principal del reloj despertador
 */

import DigitalDisplay from '../shared/DigitalDisplay.astro';
import SoundSelector from './SoundSelector.astro';
import RecentAlarms from './RecentAlarms.astro';
import AlarmPresets from './AlarmPresets.astro';
import { t, getLocaleFromPath } from '../../scripts/i18n';

const locale = getLocaleFromPath(Astro.url.pathname);

interface Props {
  presetHour?: number;
  presetMinute?: number;
  presetMeridian?: 'AM' | 'PM';
}

const { presetHour, presetMinute, presetMeridian } = Astro.props;
---

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
  <!-- Main Alarm Section (col-span-2 en desktop) -->
  <div class="lg:col-span-2 space-y-6">
    <!-- Current Time Display -->
    <div class="bg-white dark:bg-gray-900 rounded-lg p-6 shadow-lg">
      <DigitalDisplay
        id="current-time-display"
        time="12:00:00 AM"
        size="lg"
        showDate={true}
        date="Monday, January 17, 2026"
      />
    </div>

    <!-- Alarm Configuration -->
    <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-6 shadow">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
        {t(locale, 'alarm.setAlarm')}
      </h2>

      <form id="alarm-form" class="space-y-4">
        <!-- Time Selectors -->
        <div class="grid grid-cols-3 gap-4">
          <!-- Hour -->
          <div>
            <label for="alarm-hour" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              {t(locale, 'alarm.hour')}
            </label>
            <select id="alarm-hour" name="hour" class="select-input">
              {Array.from({ length: 12 }, (_, i) => i + 1).map((hour) => (
                <option value={hour} selected={hour === (presetHour || 7)}>
                  {hour}
                </option>
              ))}
            </select>
          </div>

          <!-- Minute -->
          <div>
            <label for="alarm-minute" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              {t(locale, 'alarm.minute')}
            </label>
            <input
              type="number"
              id="alarm-minute"
              name="minute"
              list="minute-options"
              class="select-input"
              min="0"
              max="59"
              step="1"
              value={presetMinute || 0}
              placeholder="00"
            />
            <datalist id="minute-options">
              {Array.from({ length: 12 }, (_, i) => i * 5).map((minute) => (
                <option value={minute}>{minute.toString().padStart(2, '0')}</option>
              ))}
            </datalist>
          </div>

          <!-- AM/PM -->
          <div>
            <label for="alarm-meridian" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              AM/PM
            </label>
            <select id="alarm-meridian" name="meridian" class="select-input">
              <option value="AM" selected={presetMeridian === 'AM' || !presetMeridian}>AM</option>
              <option value="PM" selected={presetMeridian === 'PM'}>PM</option>
            </select>
          </div>
        </div>

        <!-- Sound Selector -->
        <SoundSelector id="alarm-sound" />

        <!-- Repeat Checkbox -->
        <div class="flex items-center">
          <input
            type="checkbox"
            id="alarm-repeat"
            name="repeat"
            class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
          />
          <label for="alarm-repeat" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
            {t(locale, 'alarm.repeat')}
          </label>
        </div>

        <!-- Custom Title -->
        <div>
          <label for="alarm-title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            {t(locale, 'alarm.customTitle')}
          </label>
          <input
            type="text"
            id="alarm-title"
            name="title"
            placeholder={t(locale, 'alarm.placeholderTitle')}
            class="text-input"
            maxlength="50"
          />
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-3">
          <button
            type="submit"
            id="set-alarm-btn"
            class="btn-primary flex-1"
          >
            {t(locale, 'alarm.setAlarm')}
          </button>

          <button
            type="button"
            id="stop-alarm-btn"
            class="btn-danger flex-1 hidden"
          >
            {t(locale, 'alarm.stopAlarm')}
          </button>
        </div>

        <!-- Alarm Status -->
        <div id="alarm-status" class="hidden p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
          <div class="flex items-center space-x-2">
            <svg class="w-5 h-5 text-blue-600 dark:text-blue-400 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path>
            </svg>
            <div class="flex-1">
              <p class="text-sm font-medium text-blue-900 dark:text-blue-100">
                {t(locale, 'alarm.alarmActive')}
              </p>
              <p id="alarm-time-text" class="text-xs text-blue-700 dark:text-blue-300"></p>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Alarm Ringing Modal -->
  <div id="alarm-ringing-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-8 max-w-md w-full mx-4 animate-bounce">
      <div class="text-center">
        <div class="mb-4">
          <svg class="w-20 h-20 mx-auto text-red-600 dark:text-red-400 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path>
          </svg>
        </div>
        <h2 id="alarm-modal-title" class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
          {t(locale, 'alarm.alarmRinging')}
        </h2>
        <p id="alarm-modal-time" class="text-xl text-gray-600 dark:text-gray-400 mb-6">
          {t(locale, 'alarm.timesUp')}
        </p>
        <button
          id="dismiss-alarm-btn"
          class="btn-danger w-full text-lg py-3"
        >
          {t(locale, 'alarm.dismissAlarm')}
        </button>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="lg:col-span-1 space-y-6">
    <AlarmPresets />
    <RecentAlarms />
  </div>
</div>

<script>
  import { getAlarmClock } from '../../scripts/alarm-logic';
  import { Storage } from '../../scripts/storage';
  import { formatDate } from '../../scripts/utils';

  const alarmClock = getAlarmClock();

  // Translations - detect language from HTML lang attribute
  const translations = {
    textAlarmRinging: document.documentElement.lang.includes('es') ? 'ALARMA!' :
                       document.documentElement.lang.includes('it') ? 'SVEGLIA!' : 'ALARM!',
    textTimesUp: document.documentElement.lang.includes('es') ? '隆Se acab贸 el tiempo!' :
                  document.documentElement.lang.includes('it') ? 'Tempo scaduto!' : "Time's up!",
    textDismissAlarm: document.documentElement.lang.includes('es') ? 'Descartar' :
                       document.documentElement.lang.includes('it') ? 'Chiudi' : 'Dismiss Alarm',
    textAlarmTitle: document.documentElement.lang.includes('es') ? 'ALARMA!' :
                     document.documentElement.lang.includes('it') ? 'SVEGLIA!' : 'ALARM!',
    textAlarmSetFor: document.documentElement.lang.includes('es') ? 'Alarma configurada para {time} (en {hours}h {minutes}m)' :
                      document.documentElement.lang.includes('it') ? 'Sveglia impostata per {time} (tra {hours}h {minutes}m)' :
                      'Alarm set for {time} (in {hours}h {minutes}m)',
    textIn: document.documentElement.lang.includes('es') ? 'en' :
             document.documentElement.lang.includes('it') ? 'tra' : 'in'
  };

  // Destructure for easier access
  const { textAlarmRinging, textTimesUp, textDismissAlarm, textAlarmTitle, textAlarmSetFor, textIn } = translations;

  // Elementos del DOM
  const currentTimeDisplay = document.getElementById('current-time-display');
  const alarmForm = document.getElementById('alarm-form') as HTMLFormElement;
  const hourSelect = document.getElementById('alarm-hour') as HTMLSelectElement;
  const minuteSelect = document.getElementById('alarm-minute') as HTMLInputElement;
  const meridianSelect = document.getElementById('alarm-meridian') as HTMLSelectElement;

  // Validar y formatear input de minutos
  if (minuteSelect) {
    minuteSelect.addEventListener('blur', () => {
      let value = parseInt(minuteSelect.value) || 0;
      value = Math.max(0, Math.min(59, value)); // Clamp entre 0-59
      minuteSelect.value = value.toString();
    });
  }
  const soundSelect = document.getElementById('alarm-sound') as HTMLSelectElement;
  const repeatCheckbox = document.getElementById('alarm-repeat') as HTMLInputElement;
  const titleInput = document.getElementById('alarm-title') as HTMLInputElement;
  const setAlarmBtn = document.getElementById('set-alarm-btn') as HTMLButtonElement;
  const stopAlarmBtn = document.getElementById('stop-alarm-btn') as HTMLButtonElement;
  const alarmStatus = document.getElementById('alarm-status');
  const alarmTimeText = document.getElementById('alarm-time-text');
  const alarmModal = document.getElementById('alarm-ringing-modal');
  const alarmModalTitle = document.getElementById('alarm-modal-title');
  const alarmModalTime = document.getElementById('alarm-modal-time');
  const dismissAlarmBtn = document.getElementById('dismiss-alarm-btn');

  // Get locale from URL
  const currentLocale = window.location.pathname.startsWith('/es/') ? 'es' :
                       window.location.pathname.startsWith('/it/') ? 'it' : 'en';

  // Actualizar reloj cada segundo
  function updateCurrentTime() {
    if (!currentTimeDisplay) return;

    const timeString = alarmClock.getCurrentTimeString();
    const now = new Date();
    const dateString = formatDate(now, currentLocale);

    const timeElement = currentTimeDisplay.querySelector('.tabular-nums');
    const dateElement = currentTimeDisplay.querySelector('.text-sm');

    if (timeElement) timeElement.textContent = timeString;
    if (dateElement) dateElement.textContent = dateString;
  }

  // Actualizar cada segundo
  setInterval(updateCurrentTime, 1000);
  updateCurrentTime();

  // Cargar configuraci贸n guardada
  function loadSavedSettings() {
    const settings = alarmClock.getSettings();
    hourSelect.value = settings.hour.toString();
    minuteSelect.value = settings.minute.toString();
    meridianSelect.value = settings.meridian;
    soundSelect.value = settings.sound;
    repeatCheckbox.checked = settings.repeat;
    titleInput.value = settings.title;

    if (settings.isActive) {
      showAlarmActive();
    }
  }

  loadSavedSettings();

  // Solicitar permisos de notificaci贸n (solo cuando el usuario intente configurar una alarma)
  async function requestNotifications() {
    if (typeof Notification !== 'undefined' && Notification.permission === 'default') {
      try {
        await Notification.requestPermission();
      } catch (error) {
        console.log('Notification permission denied');
      }
    }
  }

  // Manejar submit del formulario
  alarmForm?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const hour = parseInt(hourSelect.value);
    const minute = parseInt(minuteSelect.value);
    const meridian = meridianSelect.value as 'AM' | 'PM';
    const sound = soundSelect.value;
    const repeat = repeatCheckbox.checked;
    const title = titleInput.value;

    // Solicitar permisos de notificaci贸n cuando el usuario configure la alarma
    await requestNotifications();

    // Configurar y activar alarma
    alarmClock.setAlarm(hour, minute, meridian, { sound, repeat, title });
    alarmClock.start();

    showAlarmActive();

    // Disparar evento para actualizar recent alarms
    window.dispatchEvent(new Event('alarmSet'));
  });

  // Manejar stop alarm
  stopAlarmBtn?.addEventListener('click', () => {
    alarmClock.stop();
    hideAlarmActive();
    hideAlarmModal();
  });

  // Mostrar estado de alarma activa
  function showAlarmActive() {
    setAlarmBtn?.classList.add('hidden');
    stopAlarmBtn?.classList.remove('hidden');
    alarmStatus?.classList.remove('hidden');

    updateAlarmTimeText();
  }

  // Ocultar estado de alarma activa
  function hideAlarmActive() {
    setAlarmBtn?.classList.remove('hidden');
    stopAlarmBtn?.classList.add('hidden');
    alarmStatus?.classList.add('hidden');
  }

  // Actualizar texto de tiempo hasta alarma
  function updateAlarmTimeText() {
    if (!alarmTimeText) return;

    const timeUntil = alarmClock.getTimeUntilAlarm();
    if (timeUntil) {
      const settings = alarmClock.getSettings();
      const alarmTime = `${settings.hour}:${settings.minute.toString().padStart(2, '0')} ${settings.meridian}`;
      alarmTimeText.textContent = textAlarmSetFor
        .replace('{time}', alarmTime)
        .replace('{hours}', timeUntil.hours.toString())
        .replace('{minutes}', timeUntil.minutes.toString());
    }
  }

  // Actualizar cada minuto el tiempo hasta la alarma
  setInterval(() => {
    if (alarmClock.isActive()) {
      updateAlarmTimeText();
    }
  }, 60000);

  // Manejar evento de alarma sonando
  alarmClock.onAlarm(() => {
    // Mostrar modal visual
    showAlarmModal();
  });

  // Mostrar modal de alarma sonando
  function showAlarmModal() {
    const settings = alarmClock.getSettings();
    const alarmTime = `${settings.hour}:${settings.minute.toString().padStart(2, '0')} ${settings.meridian}`;

    if (alarmModalTitle) {
      alarmModalTitle.textContent = settings.title || textAlarmRinging;
    }
    if (alarmModalTime) {
      alarmModalTime.textContent = alarmTime;
    }

    alarmModal?.classList.remove('hidden');

    // Hacer que el documento parpadee (cambio de t铆tulo)
    let titleFlash = true;
    const originalTitle = document.title;
    const flashInterval = setInterval(() => {
      document.title = titleFlash ? ` ${textAlarmTitle} ` : originalTitle;
      titleFlash = !titleFlash;
    }, 1000);

    // Guardar el intervalo para limpiarlo despu茅s
    (alarmModal as any).__flashInterval = flashInterval;
  }

  // Ocultar modal de alarma
  function hideAlarmModal() {
    alarmModal?.classList.add('hidden');

    // Restaurar t铆tulo original
    const flashInterval = (alarmModal as any).__flashInterval;
    if (flashInterval) {
      clearInterval(flashInterval);
      document.title = document.title.includes('') ? 'vClock' : document.title;
    }
  }

  // Manejar dismiss de la alarma
  dismissAlarmBtn?.addEventListener('click', () => {
    alarmClock.stop();
    hideAlarmModal();
    hideAlarmActive();
  });

  // Cargar preset desde botones de preset
  window.addEventListener('loadPresetAlarm', ((e: CustomEvent) => {
    const { hour, minute, meridian } = e.detail;
    hourSelect.value = hour.toString();
    minuteSelect.value = minute.toString();
    meridianSelect.value = meridian;
  }) as EventListener);

  // Cargar desde recent alarms
  window.addEventListener('loadRecentAlarm', ((e: CustomEvent) => {
    const { hour, minute, meridian, title } = e.detail;
    hourSelect.value = hour.toString();
    minuteSelect.value = minute.toString();
    meridianSelect.value = meridian;
    titleInput.value = title || '';
  }) as EventListener);

  // Tecla Escape para cerrar el modal de alarma
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && alarmModal && !alarmModal.classList.contains('hidden')) {
      alarmClock.stop();
      hideAlarmModal();
      hideAlarmActive();
    }
  });
</script>
