---
import { languages, getLocaleFromPath, switchLocale, getRoute, type Locale } from '../../scripts/i18n';

const currentLocale = getLocaleFromPath(Astro.url.pathname);
const currentPath = Astro.url.pathname;

// Organize languages by priority (most commonly used first)
const priorityLanguages: Locale[] = ['en', 'es', 'fr', 'de', 'pt', 'it', 'ru', 'zh-CN', 'ja', 'ar', 'hi'];

// Detectar si estamos en una p치gina de ciudad y extraer el nombre
const cityPageRegex = /\/(time|hora|ora)\/([^\/]+)/;
const cityMatch = currentPath.match(cityPageRegex);
const cityName = cityMatch ? cityMatch[2] : null;

// Mapeo de slugs de p치ginas de ciudad por idioma
const cityPageSlugs: Record<string, string | null> = {
  'en': cityName ? `/time/${cityName}` : null,
  'es': cityName ? `/es/hora/${cityName}` : null,
  'it': cityName ? `/it/ora/${cityName}` : null,
};

const languageList = Object.entries(languages).map(([code, info]) => {
  let url: string;

  // Si estamos en una p치gina de ciudad
  if (cityName) {
    // Si el idioma tiene p치gina de ciudad, usar esa URL
    if (cityPageSlugs[code]) {
      url = cityPageSlugs[code]!;
    } else {
      // Si no tiene p치gina de ciudad, redirigir al world-clock usando getRoute
      url = getRoute(code as Locale, 'clock');
    }
  } else {
    // Para otras p치ginas, usar switchLocale normal
    url = switchLocale(currentPath, code as Locale);
  }

  return {
    code: code as Locale,
    ...info,
    url,
    isPriority: priorityLanguages.includes(code as Locale),
  };
});

// Sort: priority languages first, then alphabetically by native name
languageList.sort((a, b) => {
  if (a.isPriority && !b.isPriority) return -1;
  if (!a.isPriority && b.isPriority) return 1;
  return a.nativeName.localeCompare(b.nativeName);
});
---

<div class="relative inline-block text-left">
  <button
    id="language-selector-button"
    class="flex items-center space-x-1 rtl:space-x-reverse px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500"
    aria-label="Select language"
    aria-expanded="false"
    aria-haspopup="true"
  >
    <span class="flag-emoji text-lg">{languages[currentLocale].flag}</span>
    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
      {languages[currentLocale].nativeName}
    </span>
    <svg class="w-4 h-4 text-gray-700 dark:text-gray-300" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
    </svg>
  </button>

  <!-- Dropdown Menu (Scrollable, 50 languages) -->
  <div
    id="language-selector-menu"
    class="hidden absolute end-0 mt-2 w-56 rounded-lg shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 z-50 max-h-96 overflow-y-auto"
    role="menu"
    aria-orientation="vertical"
  >
    <div class="py-1">
      {languageList.map((lang, index) => {
        const prevLang = languageList[index - 1];
        const showDivider = index > 0 && prevLang?.isPriority && !lang.isPriority;

        return (
          <>
            {showDivider && (
              <div class="border-t border-gray-200 dark:border-gray-700 my-1">
                <div class="px-4 py-1 text-xs text-gray-500 dark:text-gray-400 font-semibold">
                  Other Languages
                </div>
              </div>
            )}
            <a
              href={lang.url}
              class={`
                flex items-center space-x-2 rtl:space-x-reverse px-4 py-2 text-sm transition-colors
                ${
                  lang.code === currentLocale
                    ? 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300'
                    : 'text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'
                }
              `}
              role="menuitem"
              dir={lang.rtl ? 'rtl' : 'ltr'}
            >
              <span class="flag-emoji text-lg">{lang.flag}</span>
              <span class="font-medium">{lang.nativeName}</span>
            </a>
          </>
        );
      })}
    </div>
  </div>
</div>

<style>
  /* Mejora el renderizado de emojis de banderas en Chrome/Windows */
  .flag-emoji {
    font-family: 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji', 'Apple Color Emoji', 'Twemoji Mozilla', sans-serif;
    display: inline-block;
    line-height: 1;
    /* Fuerza el renderizado como imagen en lugar de texto */
    font-variant-emoji: emoji;
    text-rendering: optimizeLegibility;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
</style>

<script is:inline>
  // Evitar m칰ltiples inicializaciones
  if (!window.__languageSelectorInitialized) {
    window.__languageSelectorInitialized = true;

    // Toggle dropdown
    const button = document.getElementById('language-selector-button');
    const menu = document.getElementById('language-selector-menu');

    button?.addEventListener('click', () => {
      const isHidden = menu?.classList.contains('hidden');
      menu?.classList.toggle('hidden');
      button?.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (event) => {
      const target = event.target;
      if (!button?.contains(target) && !menu?.contains(target)) {
        menu?.classList.add('hidden');
        button?.setAttribute('aria-expanded', 'false');
      }
    });

    // Mapeo de idiomas a c칩digos de pa칤s para banderas
    const localeToFlag = {
      'en': 'us', 'es': 'es', 'it': 'it', 'fr': 'fr', 'de': 'de', 'pt': 'pt',
      'ru': 'ru', 'ja': 'jp', 'ko': 'kr', 'zh-CN': 'cn', 'zh-HK': 'hk',
      'ar': 'sa', 'hi': 'in', 'bn': 'bd', 'id': 'id', 'tr': 'tr', 'vi': 'vn',
      'pl': 'pl', 'nl': 'nl', 'th': 'th', 'pa': 'in', 'mr': 'in', 'te': 'in',
      'ta': 'in', 'fa': 'ir', 'ha': 'ng', 'ms': 'my', 'fil': 'ph', 'jv': 'id',
      'gu': 'in', 'am': 'et', 'yo': 'ng', 'kn': 'in', 'uk': 'ua', 'su': 'id',
      'ml': 'in', 'or': 'in', 'uz': 'uz', 'my': 'mm', 'ig': 'ng', 'sd': 'pk',
      'ro': 'ro', 'sw': 'tz', 'ne': 'np', 'cs': 'cz', 'el': 'gr', 'sv': 'se',
      'hu': 'hu', 'ur': 'pk', 'he': 'il'
    };

    let menuFlagsLoaded = false;

    // Convertir un elemento emoji de bandera a imagen SVG
    function convertFlagToImage(el, locale) {
      const countryCode = localeToFlag[locale];
      if (!countryCode) return;

      // Si ya tiene una imagen, no hacer nada
      if (el.querySelector('img')) return;

      // Si ya fue procesado (marca de conversi칩n), no hacer nada
      if (el.getAttribute('data-flag-loaded') === 'true') return;

      // Guardar emoji original si no est치 guardado
      if (!el.getAttribute('data-original-emoji')) {
        el.setAttribute('data-original-emoji', el.textContent?.trim() || '');
      }

      // Marcar como procesado
      el.setAttribute('data-flag-loaded', 'true');

      // Crear imagen SVG usando assets locales
      const img = document.createElement('img');
      img.src = `/flags/${countryCode}.svg`;
      img.alt = el.getAttribute('data-original-emoji') || '';
      img.className = 'inline-block w-5 h-4';
      img.style.verticalAlign = 'middle';
      img.onerror = function() {
        // Fallback: si la imagen falla, mostrar el emoji original
        el.innerHTML = el.getAttribute('data-original-emoji') || '游낎';
      };

      el.textContent = '';
      el.appendChild(img);
    }

    // Cargar solo la bandera del idioma actual (bot칩n)
    function loadCurrentLanguageFlag() {
      const buttonFlag = button?.querySelector('.flag-emoji');
      if (buttonFlag) {
        const currentLocale = window.location.pathname.match(/^\/([a-z]{2}(?:-[A-Z]{2})?)\//)?.[1] || 'en';
        convertFlagToImage(buttonFlag, currentLocale);
      }
    }

    // Cargar banderas del men칰 (lazy load cuando se abre)
    function loadMenuFlags() {
      if (menuFlagsLoaded) return;
      menuFlagsLoaded = true;

      const menuItems = menu?.querySelectorAll('[role="menuitem"]');
      menuItems?.forEach((item) => {
        const flagElement = item.querySelector('.flag-emoji');
        if (flagElement) {
          const link = item;
          const href = link.getAttribute('href') || '';

          // Extraer locale del href
          let locale = 'en';
          if (href === '/') {
            locale = 'en';
          } else {
            const matches = href.match(/^\/([a-z]{2}(?:-[A-Z]{2})?)\//);
            locale = matches ? matches[1] : 'en';
          }

          convertFlagToImage(flagElement, locale);
        }
      });
    }

    // Ejecutar cuando el DOM est칠 listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadCurrentLanguageFlag);
    } else {
      loadCurrentLanguageFlag();
    }

    // Cargar banderas del men칰 cuando se abre por primera vez
    button?.addEventListener('click', () => {
      const isHidden = menu?.classList.contains('hidden');
      if (isHidden) {
        // Solo cargar si se est치 abriendo el men칰
        loadMenuFlags();
      }
    });
  }  // Cerrar el if de inicializaci칩n
</script>
