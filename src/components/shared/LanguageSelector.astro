---
import { languages, getLocaleFromPath, switchLocale, type Locale } from '../../scripts/i18n';

const currentLocale = getLocaleFromPath(Astro.url.pathname);
const currentPath = Astro.url.pathname;

// Organize languages by priority (most commonly used first)
const priorityLanguages: Locale[] = ['en', 'es', 'fr', 'de', 'pt', 'it', 'ru', 'zh-CN', 'ja', 'ar', 'hi'];

const languageList = Object.entries(languages).map(([code, info]) => ({
  code: code as Locale,
  ...info,
  url: switchLocale(currentPath, code as Locale),
  isPriority: priorityLanguages.includes(code as Locale),
}));

// Sort: priority languages first, then alphabetically by native name
languageList.sort((a, b) => {
  if (a.isPriority && !b.isPriority) return -1;
  if (!a.isPriority && b.isPriority) return 1;
  return a.nativeName.localeCompare(b.nativeName);
});
---

<div class="relative inline-block text-left">
  <button
    id="language-selector-button"
    class="flex items-center space-x-1 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500"
    aria-label="Select language"
    aria-expanded="false"
    aria-haspopup="true"
  >
    <span class="text-lg">{languages[currentLocale].flag}</span>
    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
      {languages[currentLocale].nativeName}
    </span>
    <svg class="w-4 h-4 text-gray-700 dark:text-gray-300" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
    </svg>
  </button>

  <!-- Dropdown Menu (Scrollable, 50 languages) -->
  <div
    id="language-selector-menu"
    class="hidden absolute right-0 mt-2 w-56 rounded-lg shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 z-50 max-h-96 overflow-y-auto"
    role="menu"
    aria-orientation="vertical"
  >
    <div class="py-1">
      {languageList.map((lang, index) => {
        const prevLang = languageList[index - 1];
        const showDivider = index > 0 && prevLang?.isPriority && !lang.isPriority;

        return (
          <>
            {showDivider && (
              <div class="border-t border-gray-200 dark:border-gray-700 my-1">
                <div class="px-4 py-1 text-xs text-gray-500 dark:text-gray-400 font-semibold">
                  Other Languages
                </div>
              </div>
            )}
            <a
              href={lang.url}
              class={`
                flex items-center space-x-2 px-4 py-2 text-sm transition-colors
                ${
                  lang.code === currentLocale
                    ? 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300'
                    : 'text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'
                }
              `}
              role="menuitem"
              dir={lang.rtl ? 'rtl' : 'ltr'}
            >
              <span class="text-lg">{lang.flag}</span>
              <span class="font-medium">{lang.nativeName}</span>
            </a>
          </>
        );
      })}
    </div>
  </div>
</div>

<script>
  // Toggle dropdown
  const button = document.getElementById('language-selector-button');
  const menu = document.getElementById('language-selector-menu');

  button?.addEventListener('click', () => {
    const isHidden = menu?.classList.contains('hidden');
    menu?.classList.toggle('hidden');
    button?.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (event) => {
    const target = event.target as HTMLElement;
    if (!button?.contains(target) && !menu?.contains(target)) {
      menu?.classList.add('hidden');
      button?.setAttribute('aria-expanded', 'false');
    }
  });
</script>
