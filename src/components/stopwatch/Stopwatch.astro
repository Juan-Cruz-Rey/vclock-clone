---
/**
 * Stopwatch Component
 * Precision stopwatch with lap timing
 */

import { t, getLocaleFromPath } from '../../scripts/i18n';

const locale = getLocaleFromPath(Astro.url.pathname);
---

<div class="stopwatch-container max-w-4xl mx-auto">
  <!-- Stopwatch Display -->
  <div class="digital-display text-center mb-8" id="stopwatch-display">
    00:00.00
  </div>

  <!-- Control Buttons -->
  <div class="flex flex-wrap justify-center gap-4 mb-8">
    <button id="start-btn" class="btn-primary min-w-[120px]">
      {t(locale, 'common.start')}
    </button>
    <button id="pause-btn" class="btn-secondary min-w-[120px] hidden">
      {t(locale, 'common.pause')}
    </button>
    <button id="resume-btn" class="btn-primary min-w-[120px] hidden">
      {t(locale, 'common.resume')}
    </button>
    <button id="reset-btn" class="btn-secondary min-w-[120px]">
      {t(locale, 'common.reset')}
    </button>
    <button id="lap-btn" class="btn-primary min-w-[120px]" disabled>
      {t(locale, 'stopwatch.lap')}
    </button>
  </div>

  <!-- Precision Selector -->
  <div class="flex justify-center gap-2 mb-8">
    <label class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-2 self-center">
      {t(locale, 'stopwatch.precision')}:
    </label>
    <button class="precision-btn btn-secondary px-4 py-2 text-sm" data-precision="0">
      {t(locale, 'timer.seconds')}
    </button>
    <button class="precision-btn btn-secondary px-4 py-2 text-sm bg-blue-600 text-white" data-precision="2">
      Centiseconds
    </button>
    <button class="precision-btn btn-secondary px-4 py-2 text-sm" data-precision="3">
      Milliseconds
    </button>
  </div>

  <!-- Laps Section -->
  <div class="border-t border-gray-200 dark:border-gray-700 pt-8">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
        {t(locale, 'stopwatch.laps')} (<span id="lap-count">0</span>)
      </h3>
      <div class="flex gap-2">
        <button id="export-laps-btn" class="btn-secondary text-sm px-4 py-2" disabled>
          Export CSV
        </button>
        <button id="clear-laps-btn" class="btn-danger text-sm px-4 py-2" disabled>
          Clear Laps
        </button>
      </div>
    </div>

    <!-- Lap Statistics -->
    <div id="lap-stats" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 hidden">
      <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
        <div class="text-sm font-medium text-green-800 dark:text-green-200 mb-1">Fastest Lap</div>
        <div id="fastest-lap" class="text-xl font-bold text-green-900 dark:text-green-100">-</div>
      </div>
      <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
        <div class="text-sm font-medium text-red-800 dark:text-red-200 mb-1">Slowest Lap</div>
        <div id="slowest-lap" class="text-xl font-bold text-red-900 dark:text-red-100">-</div>
      </div>
      <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
        <div class="text-sm font-medium text-blue-800 dark:text-blue-200 mb-1">Average Lap</div>
        <div id="average-lap" class="text-xl font-bold text-blue-900 dark:text-blue-100">-</div>
      </div>
    </div>

    <!-- Lap Table -->
    <div class="overflow-x-auto">
      <table id="lap-table" class="w-full text-left">
        <thead class="bg-gray-100 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
          <tr>
            <th class="px-4 py-3 text-sm font-semibold text-gray-700 dark:text-gray-300">#</th>
            <th class="px-4 py-3 text-sm font-semibold text-gray-700 dark:text-gray-300">{t(locale, 'stopwatch.lapTime')}</th>
            <th class="px-4 py-3 text-sm font-semibold text-gray-700 dark:text-gray-300">{t(locale, 'stopwatch.totalTime')}</th>
            <th class="px-4 py-3 text-sm font-semibold text-gray-700 dark:text-gray-300">Difference</th>
            <th class="px-4 py-3 text-sm font-semibold text-gray-700 dark:text-gray-300"></th>
          </tr>
        </thead>
        <tbody id="lap-tbody" class="divide-y divide-gray-200 dark:divide-gray-700">
          <tr>
            <td colspan="5" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
              {t(locale, 'stopwatch.noLaps')}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script define:vars={{
  textNoLaps: t(locale, 'stopwatch.noLaps'),
  textDelete: t(locale, 'common.delete')
}}>
  import { Stopwatch, formatStopwatchTime, exportLapsToCSV, type Lap, type StopwatchPrecision } from '../../scripts/stopwatch-logic';

  // DOM Elements
  const displayEl = document.getElementById('stopwatch-display') as HTMLDivElement;
  const startBtn = document.getElementById('start-btn') as HTMLButtonElement;
  const pauseBtn = document.getElementById('pause-btn') as HTMLButtonElement;
  const resumeBtn = document.getElementById('resume-btn') as HTMLButtonElement;
  const resetBtn = document.getElementById('reset-btn') as HTMLButtonElement;
  const lapBtn = document.getElementById('lap-btn') as HTMLButtonElement;

  const precisionBtns = document.querySelectorAll('.precision-btn') as NodeListOf<HTMLButtonElement>;

  const lapCountEl = document.getElementById('lap-count') as HTMLSpanElement;
  const lapStatsEl = document.getElementById('lap-stats') as HTMLDivElement;
  const fastestLapEl = document.getElementById('fastest-lap') as HTMLDivElement;
  const slowestLapEl = document.getElementById('slowest-lap') as HTMLDivElement;
  const averageLapEl = document.getElementById('average-lap') as HTMLDivElement;
  const lapTbodyEl = document.getElementById('lap-tbody') as HTMLTableSectionElement;
  const exportLapsBtn = document.getElementById('export-laps-btn') as HTMLButtonElement;
  const clearLapsBtn = document.getElementById('clear-laps-btn') as HTMLButtonElement;

  // Initialize Stopwatch
  const stopwatch = new Stopwatch();
  let currentPrecision: StopwatchPrecision = stopwatch.getPrecision();

  function init() {
    updateDisplay(stopwatch.getElapsed());
    updateButtonStates(stopwatch.isRunning());
    updatePrecisionButtons();
    renderLaps();

    stopwatch.onTick((elapsed) => {
      updateDisplay(elapsed);
    });

    stopwatch.onStateChange((isRunning) => {
      updateButtonStates(isRunning);
    });

    stopwatch.onLap((lap) => {
      renderLaps();
    });
  }

  function updateDisplay(ms: number) {
    displayEl.textContent = formatStopwatchTime(ms, currentPrecision);
  }

  function updateButtonStates(isRunning: boolean) {
    startBtn.classList.toggle('hidden', isRunning);
    pauseBtn.classList.toggle('hidden', !isRunning);
    resumeBtn.classList.toggle('hidden', isRunning || stopwatch.getElapsed() === 0);

    lapBtn.disabled = !isRunning;
  }

  function updatePrecisionButtons() {
    precisionBtns.forEach(btn => {
      const precision = parseInt(btn.getAttribute('data-precision') || '2') as StopwatchPrecision;
      if (precision === currentPrecision) {
        btn.classList.add('bg-blue-600', 'text-white');
      } else {
        btn.classList.remove('bg-blue-600', 'text-white');
      }
    });
  }

  function renderLaps() {
    const laps = stopwatch.getLaps();
    lapCountEl.textContent = laps.length.toString();

    if (laps.length === 0) {
      lapTbodyEl.innerHTML = `
        <tr>
          <td colspan="5" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
            ${textNoLaps}
          </td>
        </tr>
      `;
      lapStatsEl.classList.add('hidden');
      exportLapsBtn.disabled = true;
      clearLapsBtn.disabled = true;
      return;
    }

    // Show stats
    lapStatsEl.classList.remove('hidden');
    exportLapsBtn.disabled = false;
    clearLapsBtn.disabled = false;

    const fastest = stopwatch.getFastestLap();
    const slowest = stopwatch.getSlowestLap();
    const average = stopwatch.getAverageLapTime();

    if (fastest) fastestLapEl.textContent = formatStopwatchTime(fastest.lapTime, currentPrecision);
    if (slowest) slowestLapEl.textContent = formatStopwatchTime(slowest.lapTime, currentPrecision);
    averageLapEl.textContent = formatStopwatchTime(average, currentPrecision);

    // Render table (reverse order - most recent first)
    const reversedLaps = [...laps].reverse();
    lapTbodyEl.innerHTML = reversedLaps.map((lap, index) => {
      const previousLap = index < reversedLaps.length - 1 ? reversedLaps[index + 1] : null;
      const diff = previousLap ? lap.lapTime - previousLap.lapTime : 0;
      const diffSign = diff > 0 ? '+' : diff < 0 ? '-' : '';
      const diffClass = diff > 0 ? 'text-red-600 dark:text-red-400' : diff < 0 ? 'text-green-600 dark:text-green-400' : 'text-gray-500 dark:text-gray-400';

      const isFastest = fastest && lap.number === fastest.number;
      const isSlowest = slowest && lap.number === slowest.number;
      const rowClass = isFastest ? 'bg-green-50 dark:bg-green-900/10' : isSlowest ? 'bg-red-50 dark:bg-red-900/10' : '';

      return `
        <tr class="${rowClass}">
          <td class="px-4 py-3 text-gray-900 dark:text-white font-semibold">
            ${lap.number}
            ${isFastest ? '<span class="ml-1 text-xs text-green-600 dark:text-green-400">‚ö°</span>' : ''}
            ${isSlowest ? '<span class="ml-1 text-xs text-red-600 dark:text-red-400">üê¢</span>' : ''}
          </td>
          <td class="px-4 py-3 text-gray-900 dark:text-white font-mono">
            ${formatStopwatchTime(lap.lapTime, currentPrecision)}
          </td>
          <td class="px-4 py-3 text-gray-600 dark:text-gray-400 font-mono">
            ${formatStopwatchTime(lap.totalTime, currentPrecision)}
          </td>
          <td class="px-4 py-3 ${diffClass} font-mono text-sm">
            ${previousLap ? `${diffSign}${formatStopwatchTime(Math.abs(diff), currentPrecision)}` : '-'}
          </td>
          <td class="px-4 py-3 text-right">
            <button
              class="delete-lap-btn text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 text-sm"
              data-lap-number="${lap.number}"
            >
              ${textDelete}
            </button>
          </td>
        </tr>
      `;
    }).join('');

    // Add event listeners to delete buttons
    document.querySelectorAll('.delete-lap-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const lapNumber = parseInt(btn.getAttribute('data-lap-number') || '0');
        stopwatch.deleteLap(lapNumber);
        renderLaps();
      });
    });
  }

  // Event Listeners
  startBtn.addEventListener('click', () => {
    stopwatch.start();
  });

  pauseBtn.addEventListener('click', () => {
    stopwatch.pause();
  });

  resumeBtn.addEventListener('click', () => {
    stopwatch.start();
  });

  resetBtn.addEventListener('click', () => {
    stopwatch.reset();
    updateDisplay(0);
    renderLaps();
  });

  lapBtn.addEventListener('click', () => {
    stopwatch.lap();
  });

  precisionBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const precision = parseInt(btn.getAttribute('data-precision') || '2') as StopwatchPrecision;
      currentPrecision = precision;
      stopwatch.setPrecision(precision);
      updatePrecisionButtons();
      updateDisplay(stopwatch.getElapsed());
      renderLaps();
    });
  });

  exportLapsBtn.addEventListener('click', () => {
    const laps = stopwatch.getLaps();
    const csv = exportLapsToCSV(laps);

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `stopwatch-laps-${new Date().toISOString().slice(0, 10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  });

  clearLapsBtn.addEventListener('click', () => {
    stopwatch.clearLaps();
    renderLaps();
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) {
      return;
    }

    if (e.code === 'Space') {
      e.preventDefault();
      if (stopwatch.isRunning()) {
        stopwatch.pause();
      } else {
        stopwatch.start();
      }
    } else if (e.code === 'KeyL' && stopwatch.isRunning()) {
      e.preventDefault();
      stopwatch.lap();
    } else if (e.code === 'KeyR' && !stopwatch.isRunning()) {
      e.preventDefault();
      stopwatch.reset();
      updateDisplay(0);
      renderLaps();
    }
  });

  // Initialize
  init();

  // Cleanup
  window.addEventListener('beforeunload', () => {
    stopwatch.destroy();
  });
</script>

<style>
  .stopwatch-container {
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  #lap-table tbody tr {
    transition: background-color 0.2s ease;
  }

  #lap-table tbody tr:hover {
    background-color: rgba(59, 130, 246, 0.05);
  }
</style>
